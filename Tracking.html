function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  // âœ… YOUR ACTUAL GOOGLE SHEET ID
  const sheet = SpreadsheetApp.openById('1JJpsAb414o8KR7RUwz_GAHNXi5IsdzxxGBFP-CpHe6o').getActiveSheet();
  const action = e.parameter.action;
  
  try {
    if (action === 'getOrder') {
      return getOrder(sheet, e.parameter.trackingNumber);
    } else if (action === 'getAllOrders') {
      return getAllOrders(sheet);
    } else if (action === 'saveOrder') {
      return saveOrder(sheet, e.parameter);
    } else {
      return createResponse({error: 'Invalid action'}, 400);
    }
  } catch (error) {
    return createResponse({error: error.toString()}, 500);
  }
}

function getOrder(sheet, trackingNumber) {
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === trackingNumber) {
      const order = {};
      headers.forEach((header, index) => {
        order[header] = data[i][index];
      });
      
      // Parse steps from JSON string
      if (order.steps) {
        try {
          order.steps = JSON.parse(order.steps);
        } catch (e) {
          order.steps = [];
        }
      } else {
        order.steps = [];
      }
      
      return createResponse(order);
    }
  }
  return createResponse({error: 'Order not found'}, 404);
}

function getAllOrders(sheet) {
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const orders = [];
  
  for (let i = 1; i < data.length; i++) {
    const order = {};
    headers.forEach((header, index) => {
      order[header] = data[i][index];
    });
    
    if (order.steps) {
      try {
        order.steps = JSON.parse(order.steps);
      } catch (e) {
        order.steps = [];
      }
    } else {
      order.steps = [];
    }
    
    orders.push(order);
  }
  
  return createResponse(orders);
}

function saveOrder(sheet, params) {
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === params.trackingNumber) {
      rowIndex = i;
      break;
    }
  }
  
  const orderData = {
    trackingNumber: params.trackingNumber,
    currentStatus: params.currentStatus,
    estimatedDelivery: params.estimatedDelivery,
    customerName: params.customerName,
    orderDetails: params.orderDetails,
    packageCount: params.packageCount,
    steps: params.steps,
    lastUpdated: new Date().toISOString()
  };
  
  if (rowIndex === -1) {
    // New order
    const newRow = headers.map(header => orderData[header] || '');
    sheet.appendRow(newRow);
  } else {
    // Update existing order
    headers.forEach((header, colIndex) => {
      sheet.getRange(rowIndex + 1, colIndex + 1).setValue(orderData[header] || '');
    });
  }
  
  return createResponse({success: true, message: 'Order saved successfully'});
}

function createResponse(data, statusCode = 200) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setStatusCode(statusCode);
}
